<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>QR-Login SPA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 2em auto;
        }

        #qr img {
            max-width: 100%;
            height: auto;
        }

        #token {
            background: #f0f0f0;
            padding: 1em;
            word-break: break-all;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 1em;
        }
    </style>
</head>
<body>
    <h1>QR-Login (API-style)</h1>
    <button id="btn">Отримати QR</button>
    <div id="qr"></div>
    <div id="token" style="display:none;">
        <h2>Ваш токен:</h2>
        <pre id="tokenValue"></pre>
    </div>

    <script>
        function getDeviceId() {
            try {
                let id = localStorage.getItem('deviceId');
                if (!id) {
                    id = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2));
                    localStorage.setItem('deviceId', id);
                }
                return id;
            } catch {
                return 'unknown-device';
            }
        }

        function detectBrowser() {
            const ua = navigator.userAgent || '';
            const vendor = navigator.vendor || '';
            let name = 'Unknown';
            let version = '';
            let engine = '';
            let engineVersion = '';

            if (/Edg\//.test(ua)) {
                name = 'Edge';
                version = (ua.match(/Edg\/([\d.]+)/) || [])[1] || '';
                engine = 'Blink';
                engineVersion = (ua.match(/AppleWebKit\/([\d.]+)/) || [])[1] || '';
            } else if (/OPR\//.test(ua)) {
                name = 'Opera';
                version = (ua.match(/OPR\/([\d.]+)/) || [])[1] || '';
                engine = 'Blink';
                engineVersion = (ua.match(/AppleWebKit\/([\d.]+)/) || [])[1] || '';
            } else if (/Chrome\//.test(ua) && /Google Inc/.test(vendor)) {
                name = 'Chrome';
                version = (ua.match(/Chrome\/([\d.]+)/) || [])[1] || '';
                engine = 'Blink';
                engineVersion = (ua.match(/AppleWebKit\/([\d.]+)/) || [])[1] || '';
            } else if (/Safari\//.test(ua) && /Apple Computer/.test(vendor)) {
                name = 'Safari';
                version = (ua.match(/Version\/([\d.]+)/) || [])[1] || '';
                engine = 'WebKit';
                engineVersion = (ua.match(/AppleWebKit\/([\d.]+)/) || [])[1] || '';
            } else if (/Firefox\//.test(ua)) {
                name = 'Firefox';
                version = (ua.match(/Firefox\/([\d.]+)/) || [])[1] || '';
                engine = 'Gecko';
                engineVersion = (ua.match(/rv:([\d.]+)/) || [])[1] || '';
            } else if (/MSIE |Trident\//.test(ua)) {
                name = 'Internet Explorer';
                version = (ua.match(/(MSIE |rv:)([\d.]+)/) || [])[2] || '';
                engine = 'Trident';
                engineVersion = (ua.match(/Trident\/([\d.]+)/) || [])[1] || '';
            }

            return {
                name,
                version,
                type: 'web',
                engine,
                engineVersion
            };
        }

        function detectOS() {
            const ua = navigator.userAgent || '';
            const platform = navigator.platform || '';
            let name = 'Unknown';
            let version = '';

            if (/Windows NT/.test(ua)) {
                name = 'Windows';
                version = (ua.match(/Windows NT ([\d.]+)/) || [])[1] || '';
            } else if (/Mac OS X/.test(ua)) {
                name = 'macOS';
                const v = (ua.match(/Mac OS X ([\d_]+)/) || [])[1];
                version = v ? v.replace(/_/g, '.') : '';
            } else if (/Android/.test(ua)) {
                name = 'Android';
                version = (ua.match(/Android ([\d.]+)/) || [])[1] || '';
            } else if (/iPhone|iPad|iPod/.test(ua)) {
                name = 'iOS';
                const v = (ua.match(/OS ([\d_]+)/) || [])[1];
                version = v ? v.replace(/_/g, '.') : '';
            } else if (/Linux/.test(ua)) {
                name = 'Linux';
            }

            return { name, version, platform };
        }

        document.getElementById('btn').onclick = async () => {
            const btn = document.getElementById('btn');
            btn.disabled = true;
            btn.textContent = 'Завантажую QR…';

            // 1) Отримуємо QR і sessionId (POST з тілом і даними браузера)
            const requestBody = {
                clientId: '1jjd-Pt0B-QFdk-x3Vw',
                clientSecret: 'lTiv0Fn0PcWqAsjQGmHrBfsrEZuSfvMjDlST6311QjEfEolUl8qjOPCEUX0JJhXMCaJFJr',
                appVersion: '1.0.0',
                language: navigator.language || 'en',
                client: {
                    device: {
                        deviceId: getDeviceId(),
                        brand: navigator.vendor || '',
                        model: '',
                        type: 'web',
                        vendorModel: ''
                    },
                    os: detectOS(),
                    browser: detectBrowser()
                }
            };

            const res = await fetch('https://localhost:7030/api/identity/qr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            const { data } = await res.json();

            // 2) Показуємо QR
            const qrDiv = document.getElementById('qr');
            qrDiv.innerHTML = `<img src="data:image/png;base64,${data.qrBase64}" alt="QR Code" />`;
            btn.textContent = 'Чекаю сканування…';

            // 3) Відкриваємо WebSocket
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            const ws = new WebSocket(`wss://localhost:7030/auth?verificationId=${data.verificationId}`);

            // 4) По повідомленню — зберігаємо токен, закриваємо WS, показуємо токен на сторінці
            ws.onmessage = evt => {
                let token;
                try {
                    token = JSON.parse(evt.data).AccessToken;
                } catch {
                    console.error('Невірний формат WS-повідомлення:', evt.data);
                    return;
                }
                localStorage.setItem('jwt', token);

                // Закриваємо WS
                ws.close(1000, 'Token received');

                // Приховуємо QR і кнопку
                qrDiv.style.display = 'none';
                btn.style.display = 'none';

                // Виводимо сам токен
                const tokenContainer = document.getElementById('token');
                document.getElementById('tokenValue').textContent = token;
                tokenContainer.style.display = 'block';
            };

            ws.onclose = evt => {
                console.log(`WebSocket закрито (code=${evt.code}, reason=${evt.reason})`);
            };
            ws.onerror = err => {
                console.error('WebSocket error:', err);
            };
        };
    </script>
</body>
</html>
